<!DOCTYPE html>
<html>
<head>
  <title>OSM Buildings</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0px;
    }
    #container {
      /*margin: 20px auto;*/
      height: 100%;
      font-family: 'Open Sans', sans-serif;
      /*background: #000000;*/
    }
    #left {
      width: 360px;
      padding: 20px;
      font-size: 12px;
      float: left;

    }
    #right {
      /*padding: 20px;*/
      overflow: auto;
      /*background: #ccc;*/
    }
    #map {
      width: 100%;
      height: 500px;
    }
    #glMap {
      width: 100%;
      height: 500px;
    }
    .glcontrol {
      /*position: absolute;*/
      left: 0;
      z-index: 1000;
      padding: 10px;
    }

    .glcontrol.tilt {
      right: 0px;
    }

    .glcontrol.rotation {
      right: 85px;
    }

    .glcontrol.zoom {
      right: 130px;
    }

    .glcontrol.zoom button {
      font-weight: normal;
    }

    .glcontrol button {
      width: 30px;
      height: 30px;
      margin: 10px 0 0 10px;
      border: 1px solid #999999;
      background: #ffffff;
      /*opacity: 0.6;*/
      /*border-radius: 2px;*/
      font-size: 14px;
      /*box-shadow: 0 0 5px #666666;*/
      /*font-weight: bold;*/
      text-align: center;
    }

    .glcontrol button:hover {
      opacity: 1;
      cursor: pointer;
    }

	textarea#styled {
		width: 350px;
		font-family: 'Open Sans', sans-serif;
		height: 200px;
		border: 3px solid #cccccc;
		padding: 5px;

	}    
	.button {
	    background-color: #4CAF50; /* Green */
	    font-family: 'Open Sans', sans-serif;
	    border: none;
	    color: white;
	    padding: 15px 32px;
	    text-align: center;
	    text-decoration: none;
	    display: inline-block;
	    font-size: 16px;
	    margin: 4px 2px;
	    cursor: pointer;
	}
	.buttongreen {
	    background-color: white; 
	    color: black; 
	    border: 2px solid #008CBA;
	}

	

  </style>
  <link rel="stylesheet" href="OSMBuildings/OSMBuildings.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="OSMBuildings/OSMBuildings.js"></script>
  <script type="text/javascript" src="js/spinjs/spin.min.js"></script>
</head>

<body>
  <div id="container">

    <div id="left">
     <p>Instructions: Use the Geodesign Hub API to get GeoJSON of your synthesis</p>
      <textarea id="gjTA" name="styled-textarea" id="styled" onfocus="this.value='';">Paste GeoJSON from Geodesign Hub here...</textarea><br>
      <input id="genStreetsCB" class="checkbox-custom" name="checkbox-1" type="checkbox" checked> Generate Streets
      <br>
      <p><button class="button" onclick="submitGJ()">Refresh Scene</button>
      <span id="spinnerCont"></span></p>
      

      <!--end left-->
    </div>
    <div id="right">
      <div id='glMap'></div>
      <br>
      <div class="glcontrol">Map Controls:
        <span class="tilt">
          <button class="dec">&#8601;</button>
          <button class="inc">&#8599;</button>
        </span>
        <span class="rotation">
          <button class="inc">&#8630;</button>
          <button class="dec">&#8631;</button>
        </span>
        <span class="zoom">
          <button class="dec">-</button>
          <button class="inc">+</button>
        </span>
      </div>
      <br>
      <!--end right-->
    </div>
    <!--container-->
  </div>

  <script>
  	var glb = {};
    var map = new GLMap('glMap', {
      position: {
        latitude: 51.478496359866696,
        longitude: 0.2217864990234375
      },
      zoom: 16,
      minZoom: 12,
      maxZoom: 20,
      state: false // stores map position/rotation in url
    });

    var osmb = new OSMBuildings({
      baseURL: './OSMBuildings',
      minZoom: 15,
      maxZoom: 22,
      attribution: '© 3D <a href="http://osmbuildings.org/copyright/">OSM Buildings</a>'
    }).addTo(map);

    osmb.addMapTiles(
      'http://{s}.tiles.mapbox.com/v3/osmbuildings.kbpalbpk/{z}/{x}/{y}.png', {
        attribution: '© Data <a href="http://openstreetmap.org/copyright/">OpenStreetMap</a> · © Map <a href="http://mapbox.com">MapBox</a>'
      }
    );
    map.setTilt(45);
    var controlButtons = document.querySelectorAll('.glcontrol button');

    for (var i = 0, il = controlButtons.length; i < il; i++) {
      controlButtons[i].addEventListener('click', function(e) {
        var button = this;
        var parentClassList = button.parentNode.classList;
        var direction = button.classList.contains('inc') ? 1 : -1;
        var increment;
        var property;

        if (parentClassList.contains('tilt')) {
          property = 'Tilt';
          increment = direction * 10;
        }
        if (parentClassList.contains('rotation')) {
          property = 'Rotation';
          increment = direction * 10;
        }
        if (parentClassList.contains('zoom')) {
          property = 'Zoom';
          increment = direction * 1;
        }
        if (property) {
          map['set' + property](map['get' + property]() + increment);
        }
      });
    }
    function setbg(color)
      {
      document.getElementById("styled").style.background=color
      }
    function submitGJ(){
    // 	var target = document.getElementById('spinnerCont');
  		// glb.spinner = new Spinner().spin();
  		// target.appendChild(glb.spinner.el);

      var gj = JSON.parse(document.getElementById("gjTA").value);
      var genstreets = document.getElementById("genStreetsCB").checked;
      start3dWorker(gj, genstreets)
    }
    function start3dWorker(allFeaturesList, genstreets) {

        var threeDWorker = new Worker('workers/3dlib.js');
        threeDWorker.onerror = function(e) {
          console.log('Error: Line ' + e.lineno + ' in ' + e.filename + ': ' + e.message);
        };
        threeDWorker.postMessage({
          'allFeaturesList': JSON.stringify(allFeaturesList),
          'genstreets': JSON.stringify(genstreets)

        });
        threeDWorker.addEventListener('message', function(e) {
          //  console.log(e.data);
          var gjsonData = e.data.polygons;
          // console.log(gjsonData);
          updateGLData(gjsonData);
        }, false);
      }

	function updateGLData(gjsonData) {
    // glb.spinner.stop();
	  if (glb.gjLayer) {
	    var k = glb.gjLayer;
	    k.destroy();
	    glb.gjLayer = "";
	  }
	  var x = osmb.addGeoJSON(JSON.parse(gjsonData));
	  glb.gjLayer = x;
	}

  </script>
</body>

</html>
